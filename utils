import { request, APIRequestContext } from "@playwright/test";
import { API_ENDPOINTS, BASE_URL } from "../config/apiConfig";

export class C2Services {
  private accessToken: string;
  private apiContext: APIRequestContext;

  constructor(username: string, password: string) {
    this.apiContext = request.newContext({ ignoreHTTPSErrors: true });
    this.login(username, password);
  }

  private async login(username: string, password: string) {
    const response = await this.apiContext.post(`${BASE_URL}${API_ENDPOINTS.LOGIN}`, {
      form: { username, password },
    });

    if (!response.ok()) {
      throw new Error(`Failed to login with status code ${response.status()}`);
    }

    const responseBody = await response.json();
    console.log("Login successful", responseBody);
    this.accessToken = responseBody.access_token;
  }

  private async requestAPI(method: string, endpoint: string, data?: object) {
    const headers = {
      Authorization: `Bearer ${this.accessToken}`,
      "Content-Type": "application/json",
    };

    const options: any = { headers, method };
    if (data) options.data = data;

    const response = await this.apiContext.fetch(`${BASE_URL}${endpoint}`, options);

    if (!response.ok()) {
      console.error(`API Request Failed: ${method} ${endpoint} - Status: ${response.status()}`);
      console.error(`Response: ${await response.text()}`);
      return null;
    }

    return await response.json();
  }

  async createEvent(eventData: object) {
    return await this.requestAPI("POST", API_ENDPOINTS.CREATE_EVENT, eventData);
  }

  async setEventState(eventID: string, action: string) {
    return await this.requestAPI("PUT", `${API_ENDPOINTS.SET_EVENT_STATE}/${eventID}`, { action });
  }

  async fetchEventTaskType() {
    const data = await this.requestAPI("GET", API_ENDPOINTS.EVENT_TASK_TYPE);
    if (data) {
      console.log("Event Task Types:", data);
    }
    return data;
  }
}
