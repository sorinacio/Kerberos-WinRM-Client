import { request } from '@playwright/test';
import { baseURL_c2, endpoints } from './endpoints';

export class ApiClient {
  public token: string | null = null;
  public loginPromise: Promise<any>;

  private baseURL: string;
  private endpoint: string;
  private username: string;
  private password: string;

  constructor(username: string, password: string) {
    this.baseURL = baseURL_c2;
    this.endpoint = endpoints.login;
    this.username = username;
    this.password = password;
    this.loginPromise = this.loginUser();
  }

  private async loginUser() {
    const loginURL = this.baseURL + this.endpoint;
    const apiContext = await request.newContext();
    const response = await apiContext.post(loginURL, {
      form: { username: this.username, password: this.password },
    });
    if (!response.ok()) {
      throw new Error(`Failed to login with status code ${response.status()}`);
    }
    const responseBody = await response.json();
    console.log('Login response:', responseBody);
    this.token = responseBody.token;
    return responseBody;
  }
}
